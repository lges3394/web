<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œå“å±•ç¤ºå¹³å°</title>
    <!-- Tailwind CSS (æ¨£å¼æ¡†æ¶) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (åœ–ç¤º) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* æ·ºç°èƒŒæ™¯ */
        }
        /* è‡ªè¨‚ Modal å‹•ç•« */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="bg-white shadow-md z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fa-solid fa-graduation-cap text-blue-600 text-2xl mr-2"></i>
                        <span class="font-bold text-xl tracking-tight text-gray-900">ä½œå“å±•ç¤ºå¹³å°</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- æ–°å¢ä½œå“æŒ‰éˆ• (ç§»è‡³å°è¦½åˆ—ï¼Œæ‰€æœ‰äººå¯è¦‹) -->
                    <button onclick="ui.openUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full text-sm font-medium transition flex items-center shadow">
                        <i class="fa-solid fa-plus mr-1"></i> æ–°å¢ä½œå“
                    </button>

                    <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (éœ€å¯†ç¢¼) -->
                    <button id="roleToggleBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium transition flex items-center">
                        <i class="fa-solid fa-user mr-1"></i> <span id="roleText">å­¸ç”Ÿæ¨¡å¼</span>
                    </button>
                    
                    <!-- é‡æ–°æ•´ç† -->
                    <button onclick="app.loadWorks()" class="text-gray-500 hover:text-blue-600 transition p-2">
                        <i class="fa-solid fa-rotate-right text-lg"></i>
                    </button>
                    <!-- èªªæ˜/ç¨‹å¼ç¢¼ -->
                    <button onclick="ui.openInfoModal()" class="text-gray-500 hover:text-blue-600 transition p-2">
                        <i class="fa-solid fa-circle-info text-lg"></i>
                    </button>
                    <!-- è¨­å®š -->
                    <button onclick="ui.openSettingsModal()" class="text-gray-500 hover:text-blue-600 transition p-2">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6">
        <div class="max-w-7xl mx-auto">
            
            <!-- ä½œå“ç¶²æ ¼ -->
            <div id="worksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS å‹•æ…‹æ’å…¥ä½œå“å¡ç‰‡ -->
            </div>

            <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
            <div id="loadingState" class="hidden flex flex-col justify-center items-center h-64">
                <div class="loader mb-4"></div>
                <p class="text-gray-500">æ­£åœ¨è®€å–è³‡æ–™åº«...</p>
            </div>
            
            <!-- ç„¡è³‡æ–™ç‹€æ…‹ -->
            <div id="emptyState" class="hidden flex flex-col justify-center items-center h-64 text-gray-400">
                <i class="fa-regular fa-folder-open text-5xl mb-4"></i>
                <p>ç›®å‰æ²’æœ‰ä»»ä½•ä½œå“</p>
            </div>
        </div>
    </main>

    <!-- ================= MODALS (æ¨¡æ…‹è¦–çª—) ================= -->

    <!-- 1. è¨­å®šè¦–çª— -->
    <div id="settingsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">âš™ï¸ é€£ç·šè¨­å®š</p>
                    <div class="modal-close cursor-pointer z-50" onclick="ui.closeModal('settingsModal')">
                        <i class="fa-solid fa-xmark text-gray-500 hover:text-black"></i>
                    </div>
                </div>
                <div class="my-5">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="gasUrlInput">
                        Google Apps Script Web App URL
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" 
                           id="gasUrlInput" type="password" placeholder="https://script.google.com/macros/s/AKfycbxjnxfMKzq0oo_qjoVlp394ie30Jx4MPb0oYO-9qjfgN__vpaOFLmIN3uElwBfsokF4/exec">
                    <p class="text-xs text-gray-500 mb-4">è«‹è¼¸å…¥éƒ¨ç½²å¾Œçš„ç¶²å€ (æ¬Šé™éœ€è¨­ç‚º Anyone)</p>

                    <!-- åˆ†äº«å€å¡Š -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100">
                        <h3 class="font-bold text-blue-800 text-sm mb-2"><i class="fa-solid fa-share-nodes"></i> ç”¢ç”Ÿåˆ†äº«é€£çµ</h3>
                        <p class="text-xs text-gray-600 mb-2">ç”¢ç”Ÿå«æœ‰è¨­å®šçš„é€£çµèˆ‡ QR Codeï¼Œè®“å­¸ç”Ÿæƒæå³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
                        <button onclick="app.generateShareLink()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            ç”¢ç”Ÿ QR Code èˆ‡é€£çµ
                        </button>
                        
                        <div id="shareResult" class="hidden mt-4 text-center">
                            <img id="qrCodeImg" class="mx-auto border p-1 bg-white mb-2" src="" alt="QR Code" width="150">
                            <p class="text-xs text-gray-500 break-all mb-2" id="shareUrlDisplay"></p>
                            <button onclick="app.copyShareLink()" class="text-blue-600 hover:text-blue-800 text-xs font-bold underline">
                                è¤‡è£½é€£çµ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end pt-2 space-x-2">
                    <button onclick="app.clearSettings()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm font-medium">æ¸…é™¤è¨­å®š</button>
                    <button onclick="app.saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ä¸Šå‚³ä½œå“è¦–çª— -->
    <div id="uploadModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">ğŸ“¤ ä¸Šå‚³ä½œå“</p>
                    <div class="modal-close cursor-pointer" onclick="ui.closeModal('uploadModal')">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                </div>
                <div class="my-5">
                    <!-- æ–°å¢ï¼šå§“åæˆ–åº§è™Ÿè¼¸å…¥æ¬„ä½ (å­¸ç”Ÿæ¨¡å¼é¡¯ç¤º) -->
                    <div id="authorInputGroup" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">å§“åæˆ–åº§è™Ÿ <span class="text-red-500">*</span></label>
                        <input id="workAuthor" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ æˆ– 05">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">æ¨™é¡Œ</label>
                        <input id="workTitle" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="è«‹è¼¸å…¥ä½œå“æ¨™é¡Œ">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ä½œå“é¡å‹</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="workType" value="image" class="form-radio text-blue-600" checked onchange="ui.toggleUploadType()">
                                <span class="ml-2">åœ–ç‰‡</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="workType" value="text" class="form-radio text-blue-600" onchange="ui.toggleUploadType()">
                                <span class="ml-2">æ–‡å­—/å…¬å‘Š</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="workType" value="url" class="form-radio text-blue-600" onchange="ui.toggleUploadType()">
                                <span class="ml-2">å¤–éƒ¨ç¶²å€</span>
                            </label>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
                    <div id="inputGroupImage" class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">é¸æ“‡åœ–ç‰‡</label>
                        <input id="workImageFile" type="file" accept="image/*" class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100">
                        <p class="text-xs text-gray-500 mt-1">ç³»çµ±å°‡è‡ªå‹•å£“ç¸®è‡³å¯¬åº¦ 800px ä»¥å…§</p>
                    </div>

                    <!-- æ–‡å­—è¼¸å…¥å€ -->
                    <div id="inputGroupText" class="mb-4 hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">å…§å®¹æè¿°</label>
                        <textarea id="workTextContent" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32"></textarea>
                    </div>

                    <!-- ç¶²å€è¼¸å…¥å€ -->
                    <div id="inputGroupUrl" class="mb-4 hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">é€£çµç¶²å€</label>
                        <input id="workUrlContent" type="url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://...">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button id="btnSubmitWork" onclick="app.submitWork()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        ç™¼å¸ƒä½œå“
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. å…¨åŸŸæç¤º Modal (å–ä»£ alert) -->
    <div id="alertModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded-lg shadow-xl z-[60] overflow-hidden">
            <div id="alertHeader" class="py-3 px-4 bg-blue-600 text-white font-bold">
                æç¤º
            </div>
            <div class="p-6">
                <p id="alertMessage" class="text-gray-700 mb-4 text-lg">è¨Šæ¯å…§å®¹</p>
                <div class="flex justify-end">
                    <button onclick="ui.closeModal('alertModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded focus:outline-none">
                        ç¢ºå®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. èªªæ˜èˆ‡ç¨‹å¼ç¢¼ Modal -->
    <div id="infoModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">â„¹ï¸ é—œæ–¼èˆ‡éƒ¨ç½²</p>
                    <div class="modal-close cursor-pointer" onclick="ui.closeModal('infoModal')">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                </div>
                <div class="my-5 text-sm text-gray-700 space-y-3">
                    <p>æ­¤ç³»çµ±éœ€è¦é…åˆ Google Apps Script (GAS) å¾Œç«¯æ‰èƒ½é‹ä½œã€‚</p>
                    <ol class="list-decimal list-inside space-y-1 bg-gray-50 p-3 rounded">
                        <li>åœ¨ Google Drive å»ºç«‹æ–°çš„ Apps Script å°ˆæ¡ˆã€‚</li>
                        <li>å°‡ä¸‹æ–¹ç¨‹å¼ç¢¼å®Œå…¨è¦†è“‹ `Code.gs`ã€‚</li>
                        <li>é»æ“Šã€Œéƒ¨ç½²ã€ -> ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€ -> é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                        <li><strong>åŸ·è¡Œèº«åˆ†ï¼šæˆ‘ (Me)</strong>ã€‚</li>
                        <li><strong>èª°å¯ä»¥å­˜å–ï¼šä»»ä½•äºº (Anyone)</strong> (é—œéµ)ã€‚</li>
                        <li>è¤‡è£½ç”¢ç”Ÿçš„ç¶²å€ï¼Œå¡«å…¥æœ¬ç¶²é çš„è¨­å®š (âš™ï¸) ä¸­ã€‚</li>
                    </ol>
                    
                    <div class="relative mt-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">Code.gs åŸå§‹ç¢¼ï¼š</span>
                            <button onclick="app.copyGasCode()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700 transition">
                                <i class="fa-regular fa-copy"></i> è¤‡è£½ç¨‹å¼ç¢¼
                            </button>
                        </div>
                        <textarea id="gasCodeDisplay" class="w-full h-48 p-2 border rounded font-mono text-xs bg-gray-800 text-green-400" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. æ•™å¸«æ¨¡å¼å¯†ç¢¼é©—è­‰ Modal (æ–°å¢) -->
    <div id="passwordModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[55]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded-lg shadow-xl z-[55] overflow-hidden">
            <div class="py-3 px-4 bg-gray-700 text-white font-bold flex justify-between items-center">
                <span>ğŸ”’ æ•™å¸«æ¨¡å¼é©—è­‰</span>
                <i class="fa-solid fa-xmark cursor-pointer" onclick="ui.closeModal('passwordModal')"></i>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-2">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥åˆ‡æ›ç‚ºæ•™å¸«èº«åˆ†ï¼š</p>
                <input id="passwordInput" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="å¯†ç¢¼">
                <div class="flex justify-end space-x-2">
                    <button onclick="ui.closeModal('passwordModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none">
                        å–æ¶ˆ
                    </button>
                    <button onclick="ui.checkPassword()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none">
                        ç¢ºèª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. è¨­å®šèˆ‡å¸¸æ•¸ ===
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxjnxfMKzq0oo_qjoVlp394ie30Jx4MPb0oYO-9qjfgN__vpaOFLmIN3uElwBfsokF4/exec"; 
        // ä¿®æ­£å¾Œçš„ Code.gs æ¨¡æ¿ï¼Œç¢ºä¿ä½¿ç”¨è€…è¤‡è£½åˆ°æ­£ç¢ºçš„ç¨‹å¼ç¢¼
        const GAS_CODE_TEMPLATE = `function doGet(e) { return handleRequest(e); }
function doPost(e) { return handleRequest(e); }
function handleRequest(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);
  try {
    initDatabase();
    let params = {};
    if (e.parameter && Object.keys(e.parameter).length > 0) params = e.parameter;
    else if (e.postData) params = JSON.parse(e.postData.contents);
    
    const action = params.action;
    let result = {};
    if(action === 'getWorks') result = getWorks(params.userId);
    else if(action === 'addWork') result = addWork(params);
    else if(action === 'likeWork') result = likeWork(params.workId, params.userId);
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) { return ContentService.createTextOutput(JSON.stringify({status:'error', message:err.toString()})).setMimeType(ContentService.MimeType.JSON); }
  finally { lock.releaseLock(); }
}
function initDatabase() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if(!ss.getSheetByName("ä½œå“åˆ—è¡¨")) ss.insertSheet("ä½œå“åˆ—è¡¨").appendRow(["ID", "ä¸Šå‚³æ™‚é–“", "é¡å‹", "æ¨™é¡Œ", "å…§å®¹", "ä½œè€…", "æŒ‰è®šæ•¸"]);
  if(!ss.getSheetByName("æŒ‰è®šç´€éŒ„")) ss.insertSheet("æŒ‰è®šç´€éŒ„").appendRow(["ç´€éŒ„ID", "ä½œå“ID", "ä½¿ç”¨è€…æŒ‡ç´‹", "æŒ‰è®šæ™‚é–“"]);
}
function getWorks(uid) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const wSheet = ss.getSheetByName("ä½œå“åˆ—è¡¨");
  const lSheet = ss.getSheetByName("æŒ‰è®šç´€éŒ„");
  const wData = wSheet.getDataRange().getValues();
  const lData = lSheet.getDataRange().getValues();
  wData.shift(); lData.shift();
  const liked = new Set();
  if(uid) lData.forEach(r => { if(String(r[2]) === String(uid)) liked.add(String(r[1])); });
  return { status:'success', data: wData.reverse().map(r => ({
    id: String(r[0]), timestamp: r[1], type: r[2], title: r[3], content: r[4], author: r[5], likes: r[6], hasLiked: liked.has(String(r[0]))
  }))};
}
function addWork(d) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("ä½œå“åˆ—è¡¨");
  // ä¿®æ­£ï¼šä½¿ç”¨å‚³å…¥çš„ author æˆ–é è¨­ç‚º "è¨ªå®¢"
  sheet.appendRow([Utilities.getUuid(), new Date().toLocaleString("zh-TW",{timeZone:"Asia/Taipei"}), d.type, d.title, d.content, d.author || "è¨ªå®¢", 0]);
  return {status:'success'};
}
function likeWork(wid, uid) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const lSheet = ss.getSheetByName("æŒ‰è®šç´€éŒ„");
  const check = lSheet.getDataRange().getValues().some(r => String(r[1])===String(wid) && String(r[2])===String(uid));
  if(check) return {status:'error', message:'å·²æŒ‰è®š'};
  const wSheet = ss.getSheetByName("ä½œå“åˆ—è¡¨");
  const wData = wSheet.getDataRange().getValues();
  for(let i=1; i<wData.length; i++) {
    if(String(wData[i][0])===String(wid)) {
      wSheet.getRange(i+1, 7).setValue((parseInt(wData[i][6])||0)+1);
      lSheet.appendRow([Utilities.getUuid(), wid, uid, new Date().toLocaleString()]);
      return {status:'success'};
    }
  }
  return {status:'error'};
}`;

        // === 2. UI æ§åˆ¶å™¨ ===
        const ui = {
            // åˆ‡æ›æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶å…¥å£
            toggleRole: () => {
                if (state.isTeacher) {
                    // å¦‚æœç›®å‰æ˜¯æ•™å¸«ï¼Œåˆ‡å›å­¸ç”Ÿ (ä¸éœ€è¦å¯†ç¢¼)
                    ui.setTeacherMode(false);
                    ui.showAlert('å·²åˆ‡æ›å›å­¸ç”Ÿæ¨¡å¼', 'info');
                } else {
                    // å¦‚æœç›®å‰æ˜¯å­¸ç”Ÿï¼Œæƒ³è®Šæ•™å¸« (éœ€è¦å¯†ç¢¼)
                    ui.openPasswordModal();
                }
            },

            // é–‹å•Ÿå¯†ç¢¼è¦–çª—
            openPasswordModal: () => {
                document.getElementById('passwordInput').value = '';
                ui.openModal('passwordModal');
                // å»¶é²èšç„¦ï¼Œæå‡é«”é©—
                setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            },

            // é©—è­‰å¯†ç¢¼é‚è¼¯
            checkPassword: () => {
                const input = document.getElementById('passwordInput').value;
                if (input === '1234') { // å¯†ç¢¼è¨­å®šè™•
                    ui.closeModal('passwordModal');
                    ui.setTeacherMode(true);
                    ui.showAlert('ç™»å…¥æˆåŠŸï¼å·²åˆ‡æ›ç‚ºæ•™å¸«æ¨¡å¼', 'success');
                } else {
                    ui.showAlert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥', 'error');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            },

            // åŸ·è¡Œå¯¦éš›çš„ UI åˆ‡æ›èˆ‡ç‹€æ…‹æ›´æ–°
            setTeacherMode: (isTeacher) => {
                state.isTeacher = isTeacher;
                const btn = document.getElementById('roleToggleBtn');
                const text = document.getElementById('roleText');
                
                if (state.isTeacher) {
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white');
                    text.innerText = "æ•™å¸«æ¨¡å¼";
                    // é€™è£¡å¯ä»¥åŠ å…¥å…¶ä»–æ•™å¸«æ¨¡å¼å°ˆå±¬çš„ UI è®ŠåŒ–
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                    btn.classList.remove('bg-blue-600', 'text-white');
                    text.innerText = "å­¸ç”Ÿæ¨¡å¼";
                }
            },
            
            toggleUploadType: () => {
                const type = document.querySelector('input[name="workType"]:checked').value;
                document.getElementById('inputGroupImage').classList.toggle('hidden', type !== 'image');
                document.getElementById('inputGroupText').classList.toggle('hidden', type !== 'text');
                document.getElementById('inputGroupUrl').classList.toggle('hidden', type !== 'url');
            },

            openModal: (modalId) => {
                const modal = document.getElementById(modalId);
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.add('modal-active');
            },

            closeModal: (modalId) => {
                const modal = document.getElementById(modalId);
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('modal-active');
            },

            openSettingsModal: () => {
                document.getElementById('gasUrlInput').value = state.gasUrl;
                ui.openModal('settingsModal');
            },
            
            openInfoModal: () => {
                document.getElementById('gasCodeDisplay').value = GAS_CODE_TEMPLATE;
                ui.openModal('infoModal');
            },
            
            // ä¿®æ”¹ï¼šé–‹å•Ÿä¸Šå‚³è¦–çª—æ™‚ï¼Œæª¢æŸ¥èº«åˆ†ä¸¦è™•ç†ä½œè€…æ¬„ä½
            openUploadModal: () => {
                const authorGroup = document.getElementById('authorInputGroup');
                const authorInput = document.getElementById('workAuthor');

                if (state.isTeacher) {
                    // æ•™å¸«æ¨¡å¼ï¼šéš±è—æ¬„ä½ (ç¨‹å¼ç¢¼æœƒè‡ªå‹•å¸¶å…¥ "æ•™å¸«")
                    authorGroup.classList.add('hidden');
                } else {
                    // å­¸ç”Ÿæ¨¡å¼ï¼šé¡¯ç¤ºæ¬„ä½ï¼Œä¸¦å˜—è©¦è®€å–è¨˜æ†¶çš„åç¨±
                    authorGroup.classList.remove('hidden');
                    const savedName = localStorage.getItem('student_name_cache') || '';
                    authorInput.value = savedName;
                }
                ui.openModal('uploadModal');
            },

            showAlert: (msg, type = 'info') => {
                const header = document.getElementById('alertHeader');
                header.className = `py-3 px-4 text-white font-bold ${type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
                header.innerText = type === 'error' ? 'éŒ¯èª¤' : 'æç¤º';
                document.getElementById('alertMessage').innerText = msg;
                ui.openModal('alertModal');
            },

            renderWorks: (works) => {
                const grid = document.getElementById('worksGrid');
                const empty = document.getElementById('emptyState');
                grid.innerHTML = '';
                
                if (!works || works.length === 0) {
                    grid.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                grid.classList.remove('hidden');
                empty.classList.add('hidden');

                works.forEach(work => {
                    let contentHtml = '';
                    if (work.type === 'image') {
                        contentHtml = `<img src="${work.content}" class="w-full h-48 object-cover" alt="${work.title}" onerror="this.src='https://via.placeholder.com/800x600?text=Image+Error'">`;
                    } else if (work.type === 'url') {
                        contentHtml = `<div class="w-full h-48 flex items-center justify-center bg-gray-100 flex-col p-4 text-center">
                            <i class="fa-solid fa-link text-4xl text-blue-400 mb-2"></i>
                            <a href="${work.content}" target="_blank" class="text-blue-600 hover:underline text-sm break-all line-clamp-2">${work.content}</a>
                        </div>`;
                    } else {
                        contentHtml = `<div class="w-full h-48 flex items-center justify-center bg-gray-100 p-6 overflow-hidden">
                            <p class="text-gray-700 text-sm line-clamp-6">${work.content}</p>
                        </div>`;
                    }

                    const likeBtnClass = work.hasLiked 
                        ? 'text-red-500 cursor-not-allowed' 
                        : 'text-gray-400 hover:text-red-500 cursor-pointer transition transform hover:scale-110';
                    
                    const likeIconClass = work.hasLiked ? 'fa-solid' : 'fa-regular';

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-300';
                    
                    // æ ¹æ“šä½œè€…èº«åˆ†é¡¯ç¤ºæ¨™ç±¤
                    let authorBadge = '';
                    if (work.author === 'æ•™å¸«') {
                        authorBadge = `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full ml-2 border border-blue-200">æ•™å¸«</span>`;
                    } else {
                        // é¡¯ç¤ºå­¸ç”Ÿå§“å
                        authorBadge = `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full ml-2">${work.author}</span>`;
                    }

                    card.innerHTML = `
                        ${contentHtml}
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-lg truncate flex-1" title="${work.title}">${work.title}</h3>
                            </div>
                            <div class="flex items-center text-xs text-gray-500 mb-3">
                                <span>${work.timestamp.split(' ')[0]}</span>
                                ${authorBadge}
                            </div>
                            <div class="flex justify-between items-center border-t pt-3">
                                <span class="text-xs text-gray-400">ID: ${work.id.substr(0,4)}</span>
                                <div class="flex items-center space-x-1">
                                    <button ${work.hasLiked ? 'disabled' : `onclick="app.likeWork('${work.id}')"`} class="${likeBtnClass} focus:outline-none">
                                        <i class="${likeIconClass} fa-heart text-xl"></i>
                                    </button>
                                    <span class="text-sm font-medium text-gray-600" id="likes-${work.id}">${work.likes}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
        };

        // === 3. æ ¸å¿ƒé‚è¼¯èˆ‡ API ===
        const state = {
            gasUrl: '',
            userId: '', // ä½¿ç”¨è€…æŒ‡ç´‹
            isTeacher: false
        };

        const app = {
            init: () => {
                // 1. ç”¢ç”Ÿä½¿ç”¨è€…æŒ‡ç´‹
                let uid = localStorage.getItem('app_user_id');
                if (!uid) {
                    uid = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('app_user_id', uid);
                }
                state.userId = uid;

                // 2. æ±ºå®š GAS URL
                const urlParams = new URLSearchParams(window.location.search);
                const configParam = urlParams.get('config');

                if (configParam) {
                    try {
                        const decodedUrl = atob(configParam);
                        state.gasUrl = decodedUrl;
                        localStorage.setItem('gas_app_url', decodedUrl);
                        // æ¸…é™¤ç¶²å€åƒæ•¸è®“çœ‹èµ·ä¾†æ›´ä¹¾æ·¨ (å¯é¸)
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (e) {
                        console.error("Config decode failed", e);
                    }
                } else {
                    const storedUrl = localStorage.getItem('gas_app_url');
                    state.gasUrl = storedUrl || DEFAULT_GAS_URL;
                }

                // 3. ç¶å®šäº‹ä»¶
                document.getElementById('roleToggleBtn').onclick = ui.toggleRole;
                
                // ç¶å®šå¯†ç¢¼è¼¸å…¥æ¡† Enter éµè§¸ç™¼
                document.getElementById('passwordInput').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        ui.checkPassword();
                    }
                });

                // 4. åˆæ¬¡è¼‰å…¥
                if (state.gasUrl) {
                    app.loadWorks();
                } else {
                    ui.showAlert('å°šæœªè¨­å®š API ç¶²å€ã€‚è«‹é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ã€é€²è¡Œè¨­å®šã€‚', 'info');
                    ui.openSettingsModal();
                }
            },

            saveSettings: () => {
                const url = document.getElementById('gasUrlInput').value.trim();
                if (!url.startsWith('https://')) {
                    ui.showAlert('ç¶²å€æ ¼å¼éŒ¯èª¤ï¼Œå¿…é ˆä»¥ https:// é–‹é ­', 'error');
                    return;
                }
                localStorage.setItem('gas_app_url', url);
                state.gasUrl = url;
                ui.closeModal('settingsModal');
                ui.showAlert('è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é‡æ–°æ•´ç†...', 'success');
                setTimeout(() => app.loadWorks(), 1000);
            },

            clearSettings: () => {
                localStorage.removeItem('gas_app_url');
                document.getElementById('gasUrlInput').value = '';
                state.gasUrl = '';
                ui.showAlert('è¨­å®šå·²æ¸…é™¤', 'info');
                setTimeout(() => location.reload(), 1000);
            },

            generateShareLink: () => {
                if (!state.gasUrl) {
                    ui.showAlert('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ GAS URL', 'error');
                    return;
                }
                const base64Url = btoa(state.gasUrl);
                // çµ„åˆç›®å‰é é¢ç¶²å€ + åƒæ•¸
                const shareUrl = `${window.location.origin}${window.location.pathname}?config=${base64Url}`;
                
                // é¡¯ç¤ºé€£çµ
                const display = document.getElementById('shareUrlDisplay');
                display.innerText = shareUrl;
                
                // ç”¢ç”Ÿ QR Code (ä½¿ç”¨ quickchart.ioï¼Œæ”¯æ´é•·ç¶²å€)
                const qrApi = `https://quickchart.io/qr?text=${encodeURIComponent(shareUrl)}&size=200`;
                document.getElementById('qrCodeImg').src = qrApi;
                
                document.getElementById('shareResult').classList.remove('hidden');
            },

            copyShareLink: () => {
                const text = document.getElementById('shareUrlDisplay').innerText;
                navigator.clipboard.writeText(text).then(() => {
                    ui.showAlert('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                });
            },

            copyGasCode: () => {
                // è¤‡è£½è®Šæ•¸ä¸­å®šç¾©çš„æ­£ç¢ºå…§å®¹
                navigator.clipboard.writeText(GAS_CODE_TEMPLATE).then(() => {
                    ui.showAlert('å¾Œç«¯ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼');
                });
            },

            // --- API å‘¼å« ---

            callApi: async (action, payload = {}) => {
                if (!state.gasUrl) return { status: 'error', message: 'æœªè¨­å®š API URL' };
                
                const data = { action, ...payload };
                
                try {
                    const response = await fetch(state.gasUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error(error);
                    return { status: 'error', message: 'é€£ç·šå¤±æ•—: ' + error.message };
                }
            },

            loadWorks: async () => {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('worksGrid').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');

                const res = await app.callApi('getWorks', { userId: state.userId });
                
                document.getElementById('loadingState').classList.add('hidden');
                
                if (res.status === 'success') {
                    // æ’åºé‚è¼¯ï¼šå°‡ä½œå“ä¾ç…§æŒ‰è®šæ•¸ (likes) ç”±å¤šåˆ°å°‘æ’åˆ—
                    const sortedWorks = res.data.sort((a, b) => {
                        return (parseInt(b.likes) || 0) - (parseInt(a.likes) || 0);
                    });
                    ui.renderWorks(sortedWorks);
                } else {
                    ui.showAlert('è®€å–å¤±æ•—: ' + res.message, 'error');
                }
            },

            submitWork: async () => {
                const title = document.getElementById('workTitle').value;
                const type = document.querySelector('input[name="workType"]:checked').value;
                let content = '';
                let authorName = '';

                // è™•ç†ä½œè€…åç¨±
                if (state.isTeacher) {
                    authorName = "æ•™å¸«";
                } else {
                    authorName = document.getElementById('workAuthor').value.trim();
                    if (!authorName) return ui.showAlert('è«‹è¼¸å…¥å§“åæˆ–åº§è™Ÿ', 'error');
                    // è¨˜æ†¶å§“å
                    localStorage.setItem('student_name_cache', authorName);
                }

                if (!title) return ui.showAlert('è«‹è¼¸å…¥æ¨™é¡Œ', 'error');

                const btn = document.getElementById('btnSubmitWork');
                btn.disabled = true;
                btn.innerText = 'è™•ç†ä¸­...';

                try {
                    if (type === 'text') {
                        content = document.getElementById('workTextContent').value;
                        if (!content) throw new Error("è«‹è¼¸å…¥å…§å®¹");
                    } else if (type === 'url') {
                        content = document.getElementById('workUrlContent').value;
                        if (!content) throw new Error("è«‹è¼¸å…¥ç¶²å€");
                    } else if (type === 'image') {
                        const fileInput = document.getElementById('workImageFile');
                        if (fileInput.files.length === 0) throw new Error("è«‹é¸æ“‡åœ–ç‰‡");
                        content = await app.processImage(fileInput.files[0]);
                    }

                    const res = await app.callApi('addWork', {
                        title, 
                        type, 
                        content,
                        // ä½¿ç”¨è¼¸å…¥çš„ä½œè€…åç¨±
                        author: authorName
                    });

                    if (res.status === 'success') {
                        ui.closeModal('uploadModal');
                        ui.showAlert('ä½œå“ç™¼å¸ƒæˆåŠŸï¼', 'success');
                        // æ¸…ç©ºè¡¨å–®
                        document.getElementById('workTitle').value = '';
                        document.getElementById('workTextContent').value = '';
                        document.getElementById('workUrlContent').value = '';
                        document.getElementById('workImageFile').value = '';
                        // ä¿ç•™å§“åæ¬„ä½ä¸æ¸…é™¤ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä¸Šå‚³
                        
                        app.loadWorks();
                    } else {
                        throw new Error(res.message);
                    }

                } catch (e) {
                    ui.showAlert(e.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'ç™¼å¸ƒä½œå“';
                }
            },

            likeWork: async (workId) => {
                const likeSpan = document.getElementById(`likes-${workId}`);
                const currentLikes = parseInt(likeSpan.innerText);
                const btn = likeSpan.parentElement.querySelector('button');
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-heart text-red-500 text-xl animate-pulse"></i>';
                likeSpan.innerText = currentLikes + 1;

                const res = await app.callApi('likeWork', {
                    workId: workId,
                    userId: state.userId
                });

                if (res.status === 'success') {
                    btn.classList.add('text-red-500', 'cursor-not-allowed');
                    btn.classList.remove('text-gray-400', 'hover:text-red-500');
                } else {
                    ui.showAlert(res.message, 'error');
                    likeSpan.innerText = currentLikes;
                    btn.innerHTML = '<i class="fa-regular fa-heart text-xl"></i>';
                    btn.disabled = false;
                }
            },

            processImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const maxWidth = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                            if (dataUrl.length > 50000) {
                                console.warn("åœ–ç‰‡ Base64 å¯èƒ½éå¤§ï¼Œè‹¥å„²å­˜å¤±æ•—è«‹é™ä½ç•«è³ª");
                            }
                            resolve(dataUrl);
                        };
                        img.onerror = (e) => reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
                    };
                    reader.onerror = (e) => reject(new Error("æª”æ¡ˆè®€å–å¤±æ•—"));
                });
            }
        };

        window.onload = app.init;

    </script>
</body>
</html>