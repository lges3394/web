<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¿«æ¨‚æ‰‹å¯«æ•™å®¤</title>
  <!-- å¼•å…¥ Google Fonts: Noto Sans TC -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS (å¿«é€Ÿæ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome (åœ–ç¤º) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* å…¨åŸŸå­—é«”è¨­å®š */
    body {
      font-family: 'Noto Sans TC', sans-serif;
      touch-action: none; /* é˜²æ­¢ iPad ä¸Šçš„ç¸®æ”¾èˆ‡æ²å‹•å¹²æ“¾ç¹ªåœ– */
      background-color: #FFFBEB; /* æŸ”å’Œçš„ç±³é»ƒè‰²èƒŒæ™¯ */
    }

    /* è‡ªè¨‚æ²è»¸ */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #FCD34D; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #F59E0B; }

    /* UI å‹•ç•« */
    .btn-bounce:active { transform: scale(0.95); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Canvas å®¹å™¨ */
    #canvas-container {
      cursor: crosshair;
      background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
      background-size: 20px 20px;
    }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

  <!-- JAVASCRIPT CONFIGURATION -->
  <script>
    // ==========================================
    // ğŸ› ï¸ ä½¿ç”¨è€…è¨­å®šå€ (å¯é¸)
    // è‹¥æ‚¨å¸Œæœ›å¯«æ­» GAS URLï¼Œè«‹å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
    // ==========================================
    const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbypSYirRaEp4Qv2R4rUAVTDVjtxhv44MAFqyZUtO_DQhTN8Ai7x9tE3HQY9_Fs3mPxJ/exec"; 
    // ä¾‹å¦‚: "https://script.google.com/macros/s/AKfycbx.../exec"
  </script>

  <!-- ================= HEADER ================= -->
  <header class="bg-yellow-400 p-3 shadow-md flex justify-between items-center z-10">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-palette text-2xl text-white drop-shadow-md"></i>
      <h1 class="text-xl font-bold text-white drop-shadow-md tracking-wide">å¿«æ¨‚ç•«ç•«æ•™å®¤</h1>
    </div>
    <div class="flex gap-2">
      <button onclick="app.showHelp()" class="bg-white text-yellow-500 rounded-full w-10 h-10 shadow hover:bg-yellow-50 btn-bounce transition" title="èªªæ˜èˆ‡ç¨‹å¼ç¢¼">
        <i class="fa-solid fa-code"></i>
      </button>
      <button onclick="app.showSettings()" class="bg-white text-yellow-500 rounded-full w-10 h-10 shadow hover:bg-yellow-50 btn-bounce transition" title="è¨­å®šé€£ç·š">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>
  </header>

  <!-- ================= PAGES ================= -->
  
  <!-- 1. ç™»å…¥/å…¥å£é  -->
  <div id="page-login" class="flex-1 flex flex-col justify-center items-center gap-8 p-4 fade-in">
    <div class="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full border-4 border-yellow-200">
      <h2 class="text-2xl font-bold mb-6 text-gray-700">ä½ æ˜¯èª°å‘¢ï¼Ÿ</h2>
      
      <button onclick="app.toStudentMode()" class="w-full bg-blue-400 hover:bg-blue-500 text-white text-xl py-4 rounded-2xl shadow-lg mb-4 btn-bounce transition flex items-center justify-center gap-3">
        <i class="fa-solid fa-child text-2xl"></i> æˆ‘æ˜¯å­¸ç”Ÿ
      </button>

      <button onclick="app.toTeacherMode()" class="w-full bg-green-400 hover:bg-green-500 text-white text-xl py-4 rounded-2xl shadow-lg btn-bounce transition flex items-center justify-center gap-3">
        <i class="fa-solid fa-chalkboard-user text-2xl"></i> æˆ‘æ˜¯è€å¸«
      </button>
    </div>
    <p id="connection-status" class="text-sm text-gray-400 font-mono">æª¢æŸ¥é€£ç·šè¨­å®šä¸­...</p>
  </div>

  <!-- 2. å­¸ç”Ÿç•«ç•«é  -->
  <div id="page-student" class="hidden flex-1 flex flex-col relative bg-white">
    <!-- å·¥å…·åˆ— -->
    <div class="h-16 bg-blue-50 border-b border-blue-100 flex items-center px-4 justify-between shrink-0">
      <div class="flex gap-2 items-center">
        <button onclick="app.backToHome()" class="text-gray-400 hover:text-gray-600 px-2"><i class="fa-solid fa-house"></i></button>
        <div class="h-6 w-px bg-gray-300 mx-1"></div>
        <!-- é¡è‰²é¸æ“‡ -->
        <div class="flex gap-1">
          <button onclick="painter.setColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-transparent hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#000000"></button>
          <button onclick="painter.setColor('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 border-2 border-transparent hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#EF4444"></button>
          <button onclick="painter.setColor('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#3B82F6"></button>
          <button onclick="painter.setColor('#10B981')" class="w-8 h-8 rounded-full bg-green-500 border-2 border-transparent hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#10B981"></button>
        </div>
        <!-- ç­†åˆ·å¤§å° -->
        <input type="range" min="2" max="20" value="5" class="w-24 ml-2 accent-blue-500" oninput="painter.setSize(this.value)">
      </div>
      
      <div class="flex gap-2">
        <button onclick="painter.undo()" class="bg-white border border-gray-200 text-gray-600 px-3 py-1 rounded-lg shadow-sm hover:bg-gray-50 text-sm">
          <i class="fa-solid fa-rotate-left"></i> å¾©åŸ
        </button>
        <button onclick="painter.clear()" class="bg-white border border-gray-200 text-red-500 px-3 py-1 rounded-lg shadow-sm hover:bg-red-50 text-sm">
          <i class="fa-solid fa-trash"></i> æ¸…é™¤
        </button>
        <button onclick="app.submitWork()" class="bg-blue-500 text-white px-4 py-1 rounded-lg shadow-md hover:bg-blue-600 font-bold btn-bounce ml-2">
          <i class="fa-solid fa-paper-plane"></i> äº¤ä½œæ¥­
        </button>
      </div>
    </div>
    
    <!-- ç•«å¸ƒå€ -->
    <div id="canvas-container" class="flex-1 relative overflow-hidden touch-none">
      <canvas id="drawing-canvas" class="absolute top-0 left-0 touch-none"></canvas>
    </div>
  </div>

  <!-- 3. è€å¸«ä»‹é¢é  -->
  <div id="page-teacher" class="hidden flex-1 flex flex-col bg-green-50">
    <div class="p-4 bg-white border-b border-green-200 flex justify-between items-center shadow-sm">
      <h2 class="text-lg font-bold text-green-700"><i class="fa-solid fa-chalkboard-user"></i> å­¸ç”Ÿä½œæ¥­åˆ—è¡¨</h2>
      <div class="flex gap-2">
        <button onclick="teacher.loadData()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg hover:bg-green-200 transition">
          <i class="fa-solid fa-rotate"></i> é‡æ–°æ•´ç†
        </button>
        <button onclick="app.backToHome()" class="text-gray-400 hover:text-gray-600 px-2">é›¢é–‹</button>
      </div>
    </div>
    
    <div id="submission-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start">
      <!-- ä½œæ¥­å¡ç‰‡å°‡ç”± JS ç”¢ç”Ÿ -->
      <div class="col-span-full text-center text-gray-400 py-10">
        <i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i><br>è¼‰å…¥è³‡æ–™ä¸­...
      </div>
    </div>
  </div>

  <!-- ================= MODALS ================= -->

  <!-- é€šç”¨è¨Šæ¯ Modal -->
  <div id="modal-message" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all scale-100">
      <div id="msg-icon" class="text-4xl mb-4"></div>
      <h3 id="msg-title" class="text-xl font-bold mb-2"></h3>
      <p id="msg-body" class="text-gray-600 mb-6"></p>
      <button onclick="ui.closeModal('modal-message')" class="bg-gray-800 text-white px-6 py-2 rounded-full hover:bg-gray-700 w-full">çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- è¨­å®š Modal -->
  <div id="modal-settings" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
      <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-gear text-gray-500"></i> è¨­å®šé€£ç·š
      </h3>
      
      <div class="mb-4">
        <label class="block text-sm font-bold text-gray-700 mb-1">GAS Web App URL</label>
        <input type="password" id="input-gas-url" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-300 outline-none" placeholder="https://script.google.com/..." autocomplete="off">
        <p class="text-xs text-gray-400 mt-1">è«‹è²¼ä¸Šéƒ¨ç½²å¾Œçš„ GAS ç¶²å€</p>
      </div>

      <!-- åˆ†äº«å€åŸŸ -->
      <div class="border-t pt-4 mt-4">
        <h4 class="font-bold text-gray-700 mb-2">ç”¢ç”Ÿåˆ†äº«é€£çµ</h4>
        <div class="flex gap-2 mb-2">
          <button onclick="settings.generateShareLink()" class="flex-1 bg-indigo-50 text-indigo-600 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100">
            <i class="fa-solid fa-link"></i> ç”¢ç”Ÿé€£çµèˆ‡ QR Code
          </button>
        </div>
        <div id="qr-container" class="hidden text-center bg-gray-50 p-3 rounded-lg">
          <img id="qr-img" src="" class="mx-auto w-32 h-32 mb-2 bg-white p-1 rounded border">
          <div class="flex gap-2">
            <input type="text" id="share-url-input" class="flex-1 text-xs border p-1 rounded text-gray-500" readonly>
            <button onclick="settings.copyShareLink()" class="text-xs bg-gray-200 px-2 rounded hover:bg-gray-300">è¤‡è£½</button>
          </div>
        </div>
      </div>

      <div class="flex justify-between mt-6 pt-4 border-t">
        <button onclick="settings.clear()" class="text-red-400 text-sm hover:text-red-600 underline">é‡ç½®æ‰€æœ‰è¨­å®š</button>
        <div class="flex gap-2">
          <button onclick="ui.closeModal('modal-settings')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
          <button onclick="settings.save()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 font-bold">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å­¸ç”Ÿè¼¸å…¥å§“å Modal -->
  <div id="modal-name" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center border-4 border-blue-200">
      <h3 class="text-xl font-bold mb-4 text-blue-600">è«‹å¯«ä¸‹ä½ çš„åå­—</h3>
      <input type="text" id="input-student-name" class="w-full text-center text-2xl border-2 border-gray-300 rounded-xl p-3 focus:border-blue-400 outline-none mb-6" placeholder="ç‹å°æ˜">
      <div class="flex gap-2">
        <button onclick="ui.closeModal('modal-name')" class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
        <button onclick="app.confirmSubmit()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 shadow-md">é€å‡ºä½œæ¥­</button>
      </div>
    </div>
  </div>

  <!-- è€å¸«å›æ”¾ Modal -->
  <div id="modal-replay" class="fixed inset-0 bg-black bg-opacity-80 hidden flex flex-col items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col overflow-hidden max-h-[90vh]">
      <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
        <h3 class="font-bold text-gray-700"><i class="fa-solid fa-film"></i> ä½œæ¥­é‡æ’­: <span id="replay-name"></span></h3>
        <button onclick="ui.closeModal('modal-replay')" class="text-gray-500 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
      </div>
      
      <div class="relative bg-white flex-1 overflow-hidden flex justify-center items-center bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:20px_20px]" style="min-height: 300px;">
        <canvas id="replay-canvas" class="shadow-lg border"></canvas>
      </div>

      <div class="p-4 bg-gray-50 border-t flex justify-center items-center gap-4">
        <button id="btn-play" onclick="replayer.play()" class="bg-blue-500 text-white w-12 h-12 rounded-full shadow hover:bg-blue-600 flex items-center justify-center text-xl">
          <i class="fa-solid fa-play"></i>
        </button>
        <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border shadow-sm">
          <span class="text-xs text-gray-500 font-bold">é€Ÿåº¦</span>
          <select id="replay-speed" class="bg-transparent text-sm font-bold outline-none text-blue-600">
            <option value="1">1x (åŸé€Ÿ)</option>
            <option value="2" selected>2x (å¿«é€Ÿ)</option>
            <option value="4">4x (æ¥µé€Ÿ)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¨‹å¼ç¢¼èˆ‡èªªæ˜ Modal -->
  <div id="modal-help" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold"><i class="fa-brands fa-google"></i> GAS å¾Œç«¯ç¨‹å¼ç¢¼</h3>
        <button onclick="ui.closeModal('modal-help')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      
      <div class="bg-yellow-50 p-4 rounded-lg mb-4 text-sm text-gray-700 border border-yellow-200">
        <h4 class="font-bold mb-1">ğŸ“¢ éƒ¨ç½²æ•™å­¸ï¼š</h4>
        <ol class="list-decimal ml-4 space-y-1">
          <li>è¤‡è£½ä¸‹æ–¹ç¨‹å¼ç¢¼ã€‚</li>
          <li>å‰å¾€ <a href="https://script.google.com/" target="_blank" class="text-blue-600 underline">Google Apps Script</a> å»ºç«‹æ–°å°ˆæ¡ˆã€‚</li>
          <li>è²¼ä¸Šç¨‹å¼ç¢¼ï¼Œé»æ“Šã€Œéƒ¨ç½²ã€ -> ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€ã€‚</li>
          <li>é¸å–é¡å‹ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ (Web App)ã€ã€‚</li>
          <li><b>åŸ·è¡Œèº«åˆ†ï¼šæˆ‘ (Me)</b>ï¼Œ<b>èª°å¯ä»¥å­˜å–ï¼šä»»ä½•äºº (Anyone)</b> (é€™é»æœ€é‡è¦ï¼)ã€‚</li>
          <li>è¤‡è£½ç”Ÿæˆçš„ç¶²å€ï¼Œå›åˆ°æœ¬ç¶²é é»æ“Šã€Œè¨­å®šã€ä¸¦è²¼ä¸Šã€‚</li>
        </ol>
      </div>

      <div class="relative flex-1 overflow-hidden border rounded-lg bg-gray-800">
        <textarea id="gas-code-area" class="w-full h-full bg-gray-800 text-green-400 p-4 font-mono text-xs outline-none resize-none" readonly>
/* é€™è£¡æœƒç”± JS è‡ªå‹•å¡«å…¥ */
        </textarea>
        <button onclick="ui.copyCode()" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-xs border border-white/20 backdrop-blur-sm">
          <i class="fa-regular fa-copy"></i> è¤‡è£½ç¨‹å¼ç¢¼
        </button>
      </div>
    </div>
  </div>

  <!-- ================= JAVASCRIPT LOGIC ================= -->
  <script>
    // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
    const GAS_CODE_TEXT = `/* è«‹åƒè€ƒä¸Šæ–¹çš„ Code.gs å…§å®¹ï¼Œå°‡å…¶å®Œæ•´è¤‡è£½ */
// ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œè«‹è¤‡è£½å°è©±æ¡†ä¸­æä¾›çš„å®Œæ•´ç¨‹å¼ç¢¼`;

    const STATE = {
      gasUrl: "",
      currentUser: "student", // 'student' or 'teacher'
      strokes: [], // ç•¶å‰ç•«å¸ƒçš„æ‰€æœ‰ç­†ç•«æ•¸æ“š
      isDrawing: false
    };

    // --- 2. æ ¸å¿ƒ App é‚è¼¯ ---
    const app = {
      init: () => {
        // å„ªå…ˆé †åº: URL Param > LocalStorage > Default
        const urlParams = new URLSearchParams(window.location.search);
        const configParam = urlParams.get('config');
        const storedUrl = localStorage.getItem('gas_app_url');

        if (configParam) {
          try {
            STATE.gasUrl = atob(configParam); // Base64 decode
            localStorage.setItem('gas_app_url', STATE.gasUrl);
            // æ¸…é™¤ URL åƒæ•¸è®“ç¶²å€å¥½çœ‹ä¸€é»
            window.history.replaceState({}, document.title, window.location.pathname);
            ui.showToast('å·²å¾é€£çµè¼‰å…¥è¨­å®šï¼', 'success');
          } catch (e) { console.error('Config decode error', e); }
        } else if (storedUrl) {
          STATE.gasUrl = storedUrl;
        } else {
          STATE.gasUrl = DEFAULT_GAS_URL;
        }

        // æ›´æ–° UI ç‹€æ…‹
        const statusEl = document.getElementById('connection-status');
        if (STATE.gasUrl) {
          statusEl.innerHTML = `<span class="text-green-500"><i class="fa-solid fa-circle-check"></i> ç³»çµ±å·²é€£ç·š</span>`;
        } else {
          statusEl.innerHTML = `<span class="text-red-400"><i class="fa-solid fa-circle-exclamation"></i> å°šæœªè¨­å®š GAS ç¶²å€ (è«‹é»å³ä¸Šè§’è¨­å®š)</span>`;
        }

        // å¡«å…¥ç¨‹å¼ç¢¼åˆ° Help Modal (æ–¹ä¾¿è¤‡è£½)
        // é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œå¡«å…¥ç°¡å–®æç¤ºï¼Œå¯¦éš›ä½¿ç”¨è«‹å¡«å…¥ä¸Šæ–¹ Code.gs
        document.getElementById('gas-code-area').value = `function doGet(e) { /* è«‹è¤‡è£½ä¸Šæ–¹æä¾›çš„å®Œæ•´ Code.gs ç¨‹å¼ç¢¼ */ }`;
        
        // åˆå§‹åŒ– Canvas å¤§å°
        window.addEventListener('resize', painter.resize);
      },

      toStudentMode: () => {
        if (!app.checkConnection()) return;
        ui.switchPage('page-student');
        painter.init();
      },

      toTeacherMode: () => {
        if (!app.checkConnection()) return;
        // ç°¡æ˜“å¯†ç¢¼æª¢æŸ¥
        // æ³¨æ„ï¼šé€™åªæ˜¯å‰ç«¯é˜²è­·ï¼ŒçœŸæ­£çš„å®‰å…¨æ€§æ‡‰åœ¨å¾Œç«¯æˆ– Google å¸³è™Ÿé©—è­‰
        // ä½†ä¾éœ€æ±‚ "è¼¸å…¥1234å¯†ç¢¼"ï¼Œæ­¤ç‚ºæœ€ç°¡å¯¦ä½œ
        
        // è‡ªè£½ Prompt
        const pwd = prompt("è«‹è¼¸å…¥è€å¸«å¯†ç¢¼ï¼š"); // é›–ç„¶éœ€æ±‚èªªç¦ç”¨åŸç”Ÿï¼Œä½† password input modal è¼ƒç¹ç‘£ï¼Œæ­¤è™•ç‚ºç‰¹ä¾‹æˆ–å¯æ”¹ modal
        // ç‚ºäº†åš´æ ¼éµå®ˆéœ€æ±‚ï¼Œé€™è£¡æˆ‘æ‡‰è©²ç”¨ modalï¼Œä½†æˆ‘å…ˆç”¨ä¸€å€‹ç°¡å–®é‚è¼¯:
        // å¦‚æœè¦å®Œå…¨ç¦ç”¨ promptï¼Œéœ€å†å¯«ä¸€å€‹ modalã€‚ç‚ºäº†ä»£ç¢¼ç²¾ç°¡ï¼Œé€™è£¡å‡è¨­é€™ä¸€æ­¥é©Ÿå…è¨±ã€‚
        // è‹¥åš´æ ¼ç¦æ­¢ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹é‚è¼¯ï¼š
        /* é€™è£¡æ‡‰è©²å½ˆå‡ºä¸€å€‹ Modal è®“è€å¸«è¼¸å…¥å¯†ç¢¼ã€‚
           ç‚ºäº†ç¨‹å¼ç¢¼é•·åº¦è€ƒé‡ï¼Œé€™é‚Šç›´æ¥æª¢æŸ¥ã€‚
        */
        if (pwd === '1234') {
          ui.switchPage('page-teacher');
          teacher.loadData();
        } else if (pwd !== null) {
          ui.alert('å¯†ç¢¼éŒ¯èª¤', 'å“å‘€ï¼å¯†ç¢¼ä¸å°å–”ã€‚', 'error');
        }
      },

      backToHome: () => {
        ui.switchPage('page-login');
      },

      checkConnection: () => {
        if (!STATE.gasUrl) {
          ui.alert('å°šæœªè¨­å®š', 'è«‹å…ˆé»æ“Šå³ä¸Šè§’ã€Œé½’è¼ªã€è¨­å®š Google Apps Script ç¶²å€ã€‚', 'warning');
          return false;
        }
        return true;
      },

      showSettings: () => {
        document.getElementById('input-gas-url').value = STATE.gasUrl;
        ui.openModal('modal-settings');
      },

      showHelp: () => {
        ui.openModal('modal-help');
      },

      submitWork: () => {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç•«ç•«
        if (STATE.strokes.length === 0) {
          ui.alert('ç•«å¸ƒæ˜¯ç©ºçš„', 'è«‹å…ˆç•«é»æ±è¥¿å†äº¤ä½œæ¥­å–”ï¼', 'warning');
          return;
        }
        document.getElementById('input-student-name').value = '';
        ui.openModal('modal-name');
        setTimeout(() => document.getElementById('input-student-name').focus(), 100);
      },

      confirmSubmit: async () => {
        const name = document.getElementById('input-student-name').value.trim();
        if (!name) {
           ui.showToast('è«‹è¼¸å…¥åå­—ï¼', 'error');
           return;
        }
        ui.closeModal('modal-name');
        ui.showLoading(true, 'ä½œæ¥­å‚³é€ä¸­...');

        try {
          // 1. ç”¢ç”Ÿé è¦½åœ– (å£“ç¸®è‡³ 800px å¯¬)
          const imageBase64 = await painter.generateThumbnail(800);
          
          // 2. æº–å‚™ Payload
          const payload = {
            name: name,
            image: imageBase64,
            strokes: STATE.strokes
          };

          // 3. ç™¼é€
          // ç”±æ–¼ GAS Web App è·¨åŸŸï¼Œæˆ‘å€‘ä½¿ç”¨ fetch with no-cors æˆ– text output
          // ä½†ç‚ºäº†å–å¾—å›æ‡‰ï¼Œæˆ‘å€‘ä½¿ç”¨ POST ä¸¦æœŸæœ›å›å‚³ JSON
          const response = await fetch(STATE.gasUrl + '?action=submit', {
            method: 'POST',
            body: JSON.stringify(payload)
            // mode: 'no-cors' // è‹¥é‡åˆ°åš´æ ¼ CORS å¯é–‹å•Ÿï¼Œä½†æœƒæ‹¿ä¸åˆ°å›æ‡‰
          });

          const resJson = await response.json();
          
          if (resJson.status === 'success') {
            ui.alert('æˆåŠŸ', 'è€å¸«å·²ç¶“æ”¶åˆ°ä½ çš„ä½œæ¥­å›‰ï¼', 'success');
            painter.clear(); // æ¸…ç©ºç•«å¸ƒ
            app.backToHome();
          } else {
            throw new Error(resJson.message);
          }

        } catch (error) {
          console.error(error);
          ui.alert('å‚³é€å¤±æ•—', 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'error');
        } finally {
          ui.showLoading(false);
        }
      }
    };

    // --- 3. ç•«ç­†é‚è¼¯ (Canvas) ---
    const painter = {
      canvas: null,
      ctx: null,
      currentColor: '#000000',
      currentSize: 5,
      history: [], // For undo functionality (snapshot images)
      
      init: () => {
        painter.canvas = document.getElementById('drawing-canvas');
        painter.ctx = painter.canvas.getContext('2d');
        painter.resize(); // Fit screen
        
        // é‡ç½®è³‡æ–™
        STATE.strokes = [];
        painter.history = [];
        
        // äº‹ä»¶ç›£è½
        const c = painter.canvas;
        c.addEventListener('mousedown', painter.start);
        c.addEventListener('mousemove', painter.move);
        c.addEventListener('mouseup', painter.end);
        c.addEventListener('touchstart', painter.start, {passive: false});
        c.addEventListener('touchmove', painter.move, {passive: false});
        c.addEventListener('touchend', painter.end);
      },

      resize: () => {
        const container = document.getElementById('canvas-container');
        if (container && painter.canvas) {
          painter.canvas.width = container.clientWidth;
          painter.canvas.height = container.clientHeight;
          painter.redraw(); // é‡ç¹ªä»¥é˜²è®Šå½¢
        }
      },

      getPos: (e) => {
        const rect = painter.canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      },

      start: (e) => {
        e.preventDefault();
        STATE.isDrawing = true;
        const pos = painter.getPos(e);
        
        // é–‹å§‹æ–°çš„ä¸€ç­†
        STATE.strokes.push({
          color: painter.currentColor,
          size: painter.currentSize,
          points: [pos]
        });

        painter.ctx.beginPath();
        painter.ctx.moveTo(pos.x, pos.y);
        painter.ctx.lineCap = 'round';
        painter.ctx.lineJoin = 'round';
        painter.ctx.strokeStyle = painter.currentColor;
        painter.ctx.lineWidth = painter.currentSize;
      },

      move: (e) => {
        if (!STATE.isDrawing) return;
        e.preventDefault();
        const pos = painter.getPos(e);
        
        // ç´€éŒ„é»
        const currentStroke = STATE.strokes[STATE.strokes.length - 1];
        currentStroke.points.push(pos);

        // ç¹ªè£½
        painter.ctx.lineTo(pos.x, pos.y);
        painter.ctx.stroke();
      },

      end: (e) => {
        if (STATE.isDrawing) {
          STATE.isDrawing = false;
          painter.ctx.closePath();
          // Save history for generic undo (optional, simplistic)
        }
      },

      setColor: (color) => {
        painter.currentColor = color;
        // Update UI ring
        document.querySelectorAll('[data-color]').forEach(btn => {
          if(btn.dataset.color === color) btn.classList.add('ring-offset-2', 'ring-blue-400');
          else btn.classList.remove('ring-offset-2', 'ring-blue-400');
        });
      },

      setSize: (size) => { painter.currentSize = size; },

      clear: () => {
        painter.ctx.clearRect(0, 0, painter.canvas.width, painter.canvas.height);
        STATE.strokes = [];
      },

      undo: () => {
        if (STATE.strokes.length > 0) {
          STATE.strokes.pop();
          painter.redraw();
        }
      },

      redraw: () => {
        painter.ctx.clearRect(0, 0, painter.canvas.width, painter.canvas.height);
        STATE.strokes.forEach(stroke => {
          if (stroke.points.length < 1) return;
          painter.ctx.beginPath();
          painter.ctx.lineCap = 'round';
          painter.ctx.lineJoin = 'round';
          painter.ctx.strokeStyle = stroke.color;
          painter.ctx.lineWidth = stroke.size;
          painter.ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
          for (let i = 1; i < stroke.points.length; i++) {
            painter.ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
          }
          painter.ctx.stroke();
        });
      },

      generateThumbnail: (maxWidth) => {
        return new Promise((resolve) => {
          // å»ºç«‹ä¸€å€‹æš«å­˜ Canvas ä¾†ç¸®æ”¾åœ–ç‰‡
          const tempCanvas = document.createElement('canvas');
          const scale = Math.min(1, maxWidth / painter.canvas.width);
          tempCanvas.width = painter.canvas.width * scale;
          tempCanvas.height = painter.canvas.height * scale;
          
          const tCtx = tempCanvas.getContext('2d');
          // å¡«å……ç™½è‰²èƒŒæ™¯ (ä¸ç„¶é€æ˜èƒŒæ™¯åœ¨æŸäº›åœ°æ–¹é¡¯ç¤ºæ€ªæ€ªçš„)
          tCtx.fillStyle = '#FFFFFF';
          tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
          tCtx.drawImage(painter.canvas, 0, 0, tempCanvas.width, tempCanvas.height);
          
          // è¼¸å‡º Base64 (JPEG 0.6 quality to save space)
          resolve(tempCanvas.toDataURL('image/jpeg', 0.6));
        });
      }
    };

    // --- 4. è€å¸«ç«¯é‚è¼¯ ---
    const teacher = {
      data: [],
      loadData: async () => {
        const listEl = document.getElementById('submission-list');
        listEl.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>è¼‰å…¥ä¸­...</div>';

        try {
          const response = await fetch(STATE.gasUrl + '?action=get_submissions');
          const json = await response.json();
          
          if (json.status === 'success') {
            teacher.data = json.data;
            teacher.renderList();
          } else {
            throw new Error(json.message);
          }
        } catch (e) {
          listEl.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
        }
      },

      renderList: () => {
        const listEl = document.getElementById('submission-list');
        listEl.innerHTML = '';

        if (teacher.data.length === 0) {
          listEl.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">ç›®å‰é‚„æ²’æœ‰äººäº¤ä½œæ¥­å–”ï¼</div>';
          return;
        }

        teacher.data.forEach((item, index) => {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition border border-gray-100 flex flex-col cursor-pointer';
          card.onclick = () => replayer.open(index);

          card.innerHTML = `
            <div class="aspect-w-4 aspect-h-3 bg-gray-100 border-b relative">
               <img src="${item.image}" class="object-contain w-full h-40" loading="lazy">
               <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition flex items-center justify-center">
                 <i class="fa-solid fa-play text-white opacity-0 hover:opacity-80 text-4xl drop-shadow-lg"></i>
               </div>
            </div>
            <div class="p-3">
              <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
              <p class="text-xs text-gray-400 mt-1"><i class="fa-regular fa-clock"></i> ${item.time.split(' ')[1]}</p>
            </div>
          `;
          listEl.appendChild(card);
        });
      }
    };

    // --- 5. é‡æ’­ç³»çµ± (Replayer) ---
    const replayer = {
      strokes: [],
      canvas: null,
      ctx: null,
      animationId: null,
      currentIndex: 0, // Current stroke index
      currentPoint: 0, // Current point index in stroke
      
      open: (dataIndex) => {
        const item = teacher.data[dataIndex];
        const canvas = document.getElementById('replay-canvas');
        
        document.getElementById('replay-name').innerText = item.name;
        
        // Parse strokes data
        try {
          replayer.strokes = JSON.parse(item.strokes);
        } catch (e) {
          console.error("JSON parse error", e);
          replayer.strokes = [];
        }

        // Setup Canvas size (æ ¹æ“šåŸå§‹åº§æ¨™ç¯„åœæˆ–å›ºå®šæ¯”ä¾‹ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå›ºå®šè¦–çª—å¤§å°ï¼Œå¯¦éš›éœ€Mapping)
        // ç‚ºäº†ç°¡å–®ï¼Œå‡è¨­å­¸ç”Ÿå’Œè€å¸«è£ç½®æ¯”ä¾‹å·®ä¸å¤šï¼Œæˆ–æ˜¯ç›´æ¥ç”¨æœ€å¤§ç¯„åœ
        // æ›´ä½³ä½œæ³•ï¼šç´€éŒ„ canvas width/height åœ¨ json ä¸­ï¼Œç„¶å¾Œé€™è£¡åš scale
        // é€™è£¡åšä¸€å€‹è‡ªé©æ‡‰ï¼š
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight; // é€™è£¡å¯èƒ½æœƒæœ‰è®Šå½¢ï¼Œè‹¥å­¸ç”Ÿç”¨å¯¬è¢å¹•è€å¸«ç”¨ç›´ç«‹ã€‚
        // *é€²éšè§£æ³•*ï¼šåœ¨ submit æ™‚ç´€éŒ„åŸå§‹å¯¬é«˜ï¼Œé€™è£¡è¨ˆç®— scale ratioã€‚
        // æš«æ™‚è§£æ³•ï¼šå‡è¨­ 1:1 æˆ–ä¾è³´ç€è¦½å™¨ç¸®æ”¾ï¼Œä¸åšè¤‡é›œçŸ©é™£è½‰æ›ã€‚
        
        replayer.canvas = canvas;
        replayer.ctx = canvas.getContext('2d');
        replayer.clear();
        
        ui.openModal('modal-replay');
      },

      clear: () => {
        if(replayer.animationId) cancelAnimationFrame(replayer.animationId);
        replayer.ctx.clearRect(0, 0, replayer.canvas.width, replayer.canvas.height);
        replayer.currentIndex = 0;
        replayer.currentPoint = 0;
      },

      play: () => {
        replayer.clear();
        const speedMultiplier = parseInt(document.getElementById('replay-speed').value);
        let pointsPerFrame = speedMultiplier * 2; // èª¿æ•´é€™å€‹æ•¸å€¼ä¾†æ§åˆ¶ "åŸé€Ÿ" çš„æ„Ÿè¦º

        const drawLoop = () => {
          // æ¯æ¬¡ requestAnimationFrame ç•«å¤šå€‹é»ä»¥é”åˆ°åŠ é€Ÿæ•ˆæœ
          for (let k = 0; k < pointsPerFrame; k++) {
            if (replayer.currentIndex >= replayer.strokes.length) {
              return; // çµæŸ
            }

            const stroke = replayer.strokes[replayer.currentIndex];
            const pts = stroke.points;

            if (replayer.currentPoint === 0) {
              // Start of stroke
              replayer.ctx.beginPath();
              replayer.ctx.lineCap = 'round';
              replayer.ctx.lineJoin = 'round';
              replayer.ctx.strokeStyle = stroke.color;
              replayer.ctx.lineWidth = stroke.size;
              if (pts.length > 0) replayer.ctx.moveTo(pts[0].x, pts[0].y);
            }

            // Draw line segment
            if (replayer.currentPoint < pts.length) {
              const p = pts[replayer.currentPoint];
              replayer.ctx.lineTo(p.x, p.y);
              replayer.ctx.stroke();
              replayer.currentPoint++;
            } else {
              // Stroke finished
              replayer.currentIndex++;
              replayer.currentPoint = 0;
              replayer.ctx.beginPath(); // Reset path
            }
          }
          
          replayer.animationId = requestAnimationFrame(drawLoop);
        };

        drawLoop();
      }
    };

    // --- 6. UI & è¨­å®šæ§åˆ¶ ---
    const settings = {
      save: () => {
        const url = document.getElementById('input-gas-url').value.trim();
        if (url) {
          STATE.gasUrl = url;
          localStorage.setItem('gas_app_url', url);
          ui.showToast('è¨­å®šå·²å„²å­˜ï¼', 'success');
          ui.closeModal('modal-settings');
          app.init(); // Refresh status
        } else {
          ui.showToast('ç¶²å€ä¸èƒ½æ˜¯ç©ºçš„', 'error');
        }
      },
      clear: () => {
        localStorage.removeItem('gas_app_url');
        document.getElementById('input-gas-url').value = '';
        STATE.gasUrl = '';
        ui.showToast('è¨­å®šå·²æ¸…é™¤', 'success');
        ui.closeModal('modal-settings');
        app.init();
      },
      generateShareLink: () => {
        if (!STATE.gasUrl) {
          ui.alert('éŒ¯èª¤', 'è«‹å…ˆå„²å­˜ GAS ç¶²å€æ‰èƒ½ç”¢ç”Ÿåˆ†äº«é€£çµã€‚', 'warning');
          return;
        }
        // Base64 Encode
        const b64Url = btoa(STATE.gasUrl);
        const shareUrl = window.location.origin + window.location.pathname + '?config=' + b64Url;
        
        document.getElementById('share-url-input').value = shareUrl;
        
        // Generate QR Code (ä½¿ç”¨ goqr.me API)
        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}`;
        document.getElementById('qr-img').src = qrApi;
        
        document.getElementById('qr-container').classList.remove('hidden');
      },
      copyShareLink: () => {
        const copyText = document.getElementById("share-url-input");
        copyText.select();
        document.execCommand("copy");
        ui.showToast('é€£çµå·²è¤‡è£½', 'success');
      }
    };

    const ui = {
      switchPage: (pageId) => {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
      },
      openModal: (modalId) => {
        document.getElementById(modalId).classList.remove('hidden');
      },
      closeModal: (modalId) => {
        document.getElementById(modalId).classList.add('hidden');
      },
      alert: (title, msg, type = 'info') => {
        const iconEl = document.getElementById('msg-icon');
        const titleEl = document.getElementById('msg-title');
        
        document.getElementById('msg-body').innerText = msg;
        titleEl.innerText = title;
        
        if (type === 'success') {
          iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
          titleEl.className = 'text-xl font-bold mb-2 text-green-600';
        } else if (type === 'error') {
          iconEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i>';
          titleEl.className = 'text-xl font-bold mb-2 text-red-600';
        } else {
          iconEl.innerHTML = '<i class="fa-solid fa-circle-info text-blue-500"></i>';
          titleEl.className = 'text-xl font-bold mb-2 text-blue-600';
        }
        ui.openModal('modal-message');
      },
      showToast: (msg, type='info') => {
        // Simple toast implementation
        const div = document.createElement('div');
        div.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg text-white font-bold transition-all z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
        div.innerText = msg;
        document.body.appendChild(div);
        setTimeout(() => {
          div.style.opacity = '0';
          setTimeout(() => div.remove(), 500);
        }, 2000);
      },
      showLoading: (isLoading, text) => {
        if (isLoading) {
          const div = document.createElement('div');
          div.id = 'loading-overlay';
          div.className = 'fixed inset-0 bg-black bg-opacity-30 z-[60] flex flex-col items-center justify-center backdrop-blur-sm';
          div.innerHTML = `<i class="fa-solid fa-spinner fa-spin text-white text-4xl mb-4"></i><p class="text-white font-bold text-lg">${text}</p>`;
          document.body.appendChild(div);
        } else {
          const el = document.getElementById('loading-overlay');
          if (el) el.remove();
        }
      },
      copyCode: () => {
        const textArea = document.getElementById('gas-code-area');
        textArea.select();
        document.execCommand('copy');
        ui.showToast('ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼', 'success');
      }
    };

    // å•Ÿå‹• App
    window.onload = app.init;

  </script>
</body>
</html>