<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>快樂手寫教室</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; touch-action: none; background-color: #FFFBEB; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #FCD34D; border-radius: 4px; }
    .btn-bounce:active { transform: scale(0.95); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #canvas-container { cursor: crosshair; background-image: radial-gradient(#E5E7EB 1px, transparent 1px); background-size: 20px 20px; }
    
    /* 重播畫布強制填滿容器，但保持比例 */
    #replay-canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

  <script>
    const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxI80290FjZDaxhjlvFmIZ5JyNuFsSQx0eLLEA6bYrHWsn5u1HNuWAvUnFKpERiNq5lRg/exec"; 
  </script>

  <!-- HEADER -->
  <header class="bg-yellow-400 p-3 shadow-md flex justify-between items-center z-10">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-palette text-2xl text-white drop-shadow-md"></i>
      <h1 class="text-xl font-bold text-white drop-shadow-md tracking-wide">快樂手寫教室</h1>
    </div>
    <div class="flex gap-2">
      <button onclick="app.showHelp()" class="bg-white text-yellow-500 rounded-full w-10 h-10 shadow hover:bg-yellow-50 btn-bounce transition"><i class="fa-solid fa-code"></i></button>
      <button onclick="app.showSettings()" class="bg-white text-yellow-500 rounded-full w-10 h-10 shadow hover:bg-yellow-50 btn-bounce transition"><i class="fa-solid fa-gear"></i></button>
    </div>
  </header>

  <!-- 1. 登入頁 -->
  <div id="page-login" class="flex-1 flex flex-col justify-center items-center gap-8 p-4 fade-in">
    <div class="bg-white p-8 rounded-3xl shadow-xl text-center max-w-md w-full border-4 border-yellow-200">
      <h2 class="text-2xl font-bold mb-6 text-gray-700">你是誰呢？</h2>
      <button onclick="app.toStudentMode()" class="w-full bg-blue-400 hover:bg-blue-500 text-white text-xl py-4 rounded-2xl shadow-lg mb-4 btn-bounce transition flex items-center justify-center gap-3"><i class="fa-solid fa-child text-2xl"></i> 我是學生</button>
      <button onclick="app.toTeacherMode()" class="w-full bg-green-400 hover:bg-green-500 text-white text-xl py-4 rounded-2xl shadow-lg btn-bounce transition flex items-center justify-center gap-3"><i class="fa-solid fa-chalkboard-user text-2xl"></i> 我是老師</button>
    </div>
    <p id="connection-status" class="text-sm text-gray-400 font-mono">檢查連線中...</p>
  </div>

  <!-- 2. 學生頁 -->
  <div id="page-student" class="hidden flex-1 flex flex-col relative bg-white">
    <div class="h-16 bg-blue-50 border-b border-blue-100 flex items-center px-4 justify-between shrink-0">
      <div class="flex gap-2 items-center">
        <button onclick="app.backToHome()" class="text-gray-400 hover:text-gray-600 px-2"><i class="fa-solid fa-house"></i></button>
        <div class="h-6 w-px bg-gray-300 mx-1"></div>
        <div class="flex gap-1">
          <button onclick="painter.setColor('#000000')" class="w-8 h-8 rounded-full bg-black ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#000000"></button>
          <button onclick="painter.setColor('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#EF4444"></button>
          <button onclick="painter.setColor('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#3B82F6"></button>
          <button onclick="painter.setColor('#10B981')" class="w-8 h-8 rounded-full bg-green-500 ring-2 ring-offset-1 ring-transparent focus:ring-blue-400" data-color="#10B981"></button>
        </div>
        <input type="range" min="2" max="20" value="5" class="w-24 ml-2 accent-blue-500" oninput="painter.setSize(this.value)">
      </div>
      <div class="flex gap-2">
        <button onclick="painter.undo()" class="bg-white border text-gray-600 px-3 py-1 rounded-lg shadow-sm hover:bg-gray-50 text-sm"><i class="fa-solid fa-rotate-left"></i> 復原</button>
        <button onclick="painter.clear()" class="bg-white border text-red-500 px-3 py-1 rounded-lg shadow-sm hover:bg-red-50 text-sm"><i class="fa-solid fa-trash"></i> 清除</button>
        <button onclick="app.submitWork()" class="bg-blue-500 text-white px-4 py-1 rounded-lg shadow-md hover:bg-blue-600 font-bold btn-bounce ml-2"><i class="fa-solid fa-paper-plane"></i> 交作業</button>
      </div>
    </div>
    <div id="canvas-container" class="flex-1 relative overflow-hidden touch-none">
      <canvas id="drawing-canvas" class="absolute top-0 left-0 touch-none"></canvas>
    </div>
  </div>

  <!-- 3. 老師頁 -->
  <div id="page-teacher" class="hidden flex-1 flex flex-col bg-green-50">
    <div class="p-4 bg-white border-b border-green-200 flex justify-between items-center shadow-sm">
      <h2 class="text-lg font-bold text-green-700"><i class="fa-solid fa-chalkboard-user"></i> 學生作業列表</h2>
      <div class="flex gap-2">
        <button onclick="teacher.loadData()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg hover:bg-green-200 transition"><i class="fa-solid fa-rotate"></i> 重新整理</button>
        <button onclick="app.backToHome()" class="text-gray-400 hover:text-gray-600 px-2">離開</button>
      </div>
    </div>
    <div id="submission-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start"></div>
  </div>

  <!-- MODALS -->
  <div id="modal-message" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
      <div id="msg-icon" class="text-4xl mb-4"></div>
      <h3 id="msg-title" class="text-xl font-bold mb-2"></h3>
      <p id="msg-body" class="text-gray-600 mb-6"></p>
      <button onclick="ui.closeModal('modal-message')" class="bg-gray-800 text-white px-6 py-2 rounded-full w-full">知道了</button>
    </div>
  </div>

  <div id="modal-settings" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
      <h3 class="text-xl font-bold mb-4"><i class="fa-solid fa-gear"></i> 設定連線</h3>
      <div class="mb-4">
        <label class="block text-sm font-bold text-gray-700 mb-1">GAS Web App URL</label>
        <input type="password" id="input-gas-url" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-300 outline-none" placeholder="https://script.google.com/...">
      </div>
      <div class="border-t pt-4 mt-4">
        <button onclick="settings.generateShareLink()" class="w-full bg-indigo-50 text-indigo-600 py-2 rounded-lg text-sm font-bold mb-2"><i class="fa-solid fa-link"></i> 產生分享連結</button>
        <div id="qr-container" class="hidden text-center bg-gray-50 p-3 rounded-lg">
          <img id="qr-img" src="" class="mx-auto w-32 h-32 mb-2 bg-white p-1 rounded border">
          <div class="flex gap-2">
            <input type="text" id="share-url-input" class="flex-1 text-xs border p-1 rounded text-gray-500" readonly>
            <button onclick="settings.copyShareLink()" class="text-xs bg-gray-200 px-2 rounded">複製</button>
          </div>
        </div>
      </div>
      <div class="flex justify-between mt-6 pt-4 border-t">
        <button onclick="settings.clear()" class="text-red-400 text-sm underline">重置</button>
        <div class="flex gap-2">
          <button onclick="ui.closeModal('modal-settings')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded-lg">取消</button>
          <button onclick="settings.save()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-bold">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-name" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center border-4 border-blue-200">
      <h3 class="text-xl font-bold mb-4 text-blue-600">請輸入你的座號</h3>
      <input type="number" id="input-student-name" class="w-full text-center text-3xl border-2 border-gray-300 rounded-xl p-3 mb-6 font-mono font-bold" placeholder="例如: 5">
      <div class="flex gap-2">
        <button onclick="ui.closeModal('modal-name')" class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
        <button onclick="app.confirmSubmit()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md">送出作業</button>
      </div>
    </div>
  </div>

  <div id="modal-replay" class="fixed inset-0 bg-black bg-opacity-80 hidden flex flex-col items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col overflow-hidden max-h-[90vh]">
      <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
        <!-- 增加筆畫數顯示，方便除錯 -->
        <h3 class="font-bold text-gray-700"><i class="fa-solid fa-film"></i> 座號: <span id="replay-name"></span> <span id="replay-info" class="text-xs text-gray-400 ml-2"></span></h3>
        <button onclick="ui.closeModal('modal-replay')" class="text-gray-500 hover:text-red-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <!-- 畫布區 -->
      <div id="replay-container" class="relative bg-white flex-1 overflow-hidden flex justify-center items-center bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:20px_20px]" style="min-height: 300px;">
        <canvas id="replay-canvas" class="shadow-lg border"></canvas>
      </div>
      <div class="p-4 bg-gray-50 border-t flex justify-center items-center gap-4">
        <button id="btn-play" onclick="replayer.play()" class="bg-blue-500 text-white w-12 h-12 rounded-full shadow hover:bg-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-play"></i></button>
        <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border shadow-sm">
          <span class="text-xs text-gray-500 font-bold">速度</span>
          <select id="replay-speed" class="bg-transparent text-sm font-bold outline-none text-blue-600">
            <option value="1">1x</option>
            <option value="2" selected>2x</option>
            <option value="4">4x</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-help" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">GAS 後端程式碼</h3><button onclick="ui.closeModal('modal-help')"><i class="fa-solid fa-xmark"></i></button></div>
      <div class="bg-yellow-50 p-4 rounded-lg mb-4 text-sm text-gray-700 border border-yellow-200">
        <p class="font-bold text-red-500 mb-1"><i class="fa-solid fa-circle-exclamation"></i> 請確認 SPREADSHEET_ID 設定</p>
      </div>
      <div class="relative flex-1 overflow-hidden border rounded-lg bg-gray-800">
        <textarea id="gas-code-area" class="w-full h-full bg-gray-800 text-green-400 p-4 font-mono text-xs outline-none resize-none" readonly>/* 程式碼請複製 Code.gs */</textarea>
        <button onclick="ui.copyCode()" class="absolute top-2 right-2 bg-white/10 text-white px-3 py-1 rounded text-xs border">複製程式碼</button>
      </div>
    </div>
  </div>

  <script>
    const STATE = { gasUrl: "", strokes: [], isDrawing: false };

    const app = {
      init: () => {
        const urlParams = new URLSearchParams(window.location.search);
        const configParam = urlParams.get('config');
        const storedUrl = localStorage.getItem('gas_app_url');
        
        if (configParam) {
          try { STATE.gasUrl = atob(configParam); localStorage.setItem('gas_app_url', STATE.gasUrl); window.history.replaceState({}, document.title, window.location.pathname); ui.showToast('設定已載入！', 'success'); } catch (e) {}
        } else if (storedUrl) { STATE.gasUrl = storedUrl; }
        else { STATE.gasUrl = DEFAULT_GAS_URL; }
        
        const statusEl = document.getElementById('connection-status');
        if (STATE.gasUrl) statusEl.innerHTML = `<span class="text-green-500"><i class="fa-solid fa-circle-check"></i> 系統已連線</span>`;
        else statusEl.innerHTML = `<span class="text-red-400">尚未設定 GAS 網址</span>`;
        
        window.addEventListener('resize', painter.resize);
      },
      toStudentMode: () => { if(app.checkConnection()){ ui.switchPage('page-student'); painter.init(); } },
      toTeacherMode: () => {
        if(!app.checkConnection()) return;
        const pwd = prompt("請輸入老師密碼：");
        if (pwd === '1234') { ui.switchPage('page-teacher'); teacher.loadData(); }
        else if (pwd !== null) ui.alert('密碼錯誤', '哎呀！密碼不對喔。', 'error');
      },
      backToHome: () => { ui.switchPage('page-login'); },
      checkConnection: () => { if(!STATE.gasUrl){ ui.alert('尚未設定', '請點右上角設定 GAS URL', 'warning'); return false; } return true; },
      showSettings: () => { document.getElementById('input-gas-url').value = STATE.gasUrl; ui.openModal('modal-settings'); },
      showHelp: () => { ui.openModal('modal-help'); },
      submitWork: () => { if(STATE.strokes.length === 0){ ui.alert('空的', '請先畫畫！', 'warning'); return; } document.getElementById('input-student-name').value = ''; ui.openModal('modal-name'); },
      confirmSubmit: async () => {
        const name = document.getElementById('input-student-name').value.trim();
        if(!name) { ui.showToast('請輸入座號', 'error'); return; }
        ui.closeModal('modal-name');
        ui.showLoading(true, '傳送中...');
        try {
          const img = await painter.generateThumbnail(800);
          const res = await fetch(STATE.gasUrl + '?action=submit', {
            method: 'POST', body: JSON.stringify({ name: name, image: img, strokes: STATE.strokes })
          });
          const json = await res.json();
          if(json.status === 'success') { ui.alert('成功', '作業已送出！', 'success'); painter.clear(); app.backToHome(); }
          else throw new Error(json.message);
        } catch(e) { ui.alert('失敗', e.message, 'error'); } 
        finally { ui.showLoading(false); }
      }
    };

    const painter = {
      canvas: null, ctx: null, currentColor: '#000000', currentSize: 5,
      init: () => {
        painter.canvas = document.getElementById('drawing-canvas');
        painter.ctx = painter.canvas.getContext('2d');
        painter.resize();
        STATE.strokes = [];
        const c = painter.canvas;
        c.addEventListener('mousedown', painter.start); c.addEventListener('mousemove', painter.move); c.addEventListener('mouseup', painter.end);
        c.addEventListener('touchstart', painter.start, {passive: false}); c.addEventListener('touchmove', painter.move, {passive: false}); c.addEventListener('touchend', painter.end);
      },
      resize: () => {
        const container = document.getElementById('canvas-container');
        if(container && painter.canvas){ painter.canvas.width = container.clientWidth; painter.canvas.height = container.clientHeight; painter.redraw(); }
      },
      getPos: (e) => {
        const rect = painter.canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      },
      start: (e) => {
        e.preventDefault(); STATE.isDrawing = true; const pos = painter.getPos(e);
        STATE.strokes.push({ color: painter.currentColor, size: painter.currentSize, points: [pos] });
        painter.ctx.beginPath(); painter.ctx.moveTo(pos.x, pos.y); painter.ctx.lineCap = 'round'; painter.ctx.lineJoin = 'round'; painter.ctx.strokeStyle = painter.currentColor; painter.ctx.lineWidth = painter.currentSize;
      },
      move: (e) => {
        if(!STATE.isDrawing) return; e.preventDefault(); const pos = painter.getPos(e);
        STATE.strokes[STATE.strokes.length-1].points.push(pos);
        painter.ctx.lineTo(pos.x, pos.y); painter.ctx.stroke();
      },
      end: () => { STATE.isDrawing = false; painter.ctx.closePath(); },
      setColor: (c) => { painter.currentColor = c; document.querySelectorAll('[data-color]').forEach(b => b.classList.toggle('ring-blue-400', b.dataset.color === c)); },
      setSize: (s) => painter.currentSize = s,
      clear: () => { painter.ctx.clearRect(0,0,painter.canvas.width, painter.canvas.height); STATE.strokes=[]; },
      undo: () => { STATE.strokes.pop(); painter.redraw(); },
      redraw: () => {
        painter.ctx.clearRect(0,0,painter.canvas.width, painter.canvas.height);
        STATE.strokes.forEach(s => {
          if(s.points.length<1)return;
          painter.ctx.beginPath(); painter.ctx.lineCap='round'; painter.ctx.lineJoin='round'; painter.ctx.strokeStyle=s.color; painter.ctx.lineWidth=s.size;
          painter.ctx.moveTo(s.points[0].x, s.points[0].y);
          for(let i=1;i<s.points.length;i++) painter.ctx.lineTo(s.points[i].x, s.points[i].y);
          painter.ctx.stroke();
        });
      },
      generateThumbnail: (w) => {
        return new Promise(r => {
          const t = document.createElement('canvas'); const s = Math.min(1, w/painter.canvas.width);
          t.width = painter.canvas.width*s; t.height = painter.canvas.height*s;
          const ctx = t.getContext('2d'); ctx.fillStyle='#FFFFFF'; ctx.fillRect(0,0,t.width,t.height); ctx.drawImage(painter.canvas,0,0,t.width,t.height);
          r(t.toDataURL('image/jpeg', 0.6));
        });
      }
    };

    const teacher = {
      data: [],
      loadData: async () => {
        const l = document.getElementById('submission-list');
        l.innerHTML = '<div class="col-span-full text-center py-10"><i class="fa-solid fa-spinner fa-spin"></i> 載入中...</div>';
        try {
          const res = await fetch(STATE.gasUrl + '?action=get_submissions');
          const json = await res.json();
          if(json.status === 'success'){ teacher.data = json.data; teacher.renderList(); }
          else throw new Error(json.message);
        } catch(e) { l.innerHTML = `<div class="text-red-500 col-span-full text-center">載入失敗: ${e.message}<br><span class="text-xs text-gray-500">(請檢查 GAS 後端 SPREADSHEET_ID 是否設定)</span></div>`; }
      },
      renderList: () => {
        const l = document.getElementById('submission-list'); l.innerHTML = '';
        if(teacher.data.length===0){ l.innerHTML='<div class="col-span-full text-center text-gray-400">目前沒有作業</div>'; return; }
        teacher.data.forEach((item, idx) => {
          const d = document.createElement('div');
          d.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer';
          d.innerHTML = `<div class="aspect-w-4 aspect-h-3 bg-gray-100 border-b relative"><img src="${item.image}" class="object-contain w-full h-40"><div class="absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/10 transition"><i class="fa-solid fa-play text-white opacity-0 hover:opacity-80 text-4xl shadow-lg"></i></div></div><div class="p-3"><h3 class="font-bold text-gray-800">座號：${item.name}</h3><p class="text-xs text-gray-400">${item.time}</p></div>`;
          d.onclick = () => replayer.open(idx);
          l.appendChild(d);
        });
      }
    };

    // --- 關鍵修復：重播器 (Replayer) ---
    // 策略：使用固定虛擬解析度 1000x800，避免依賴 CSS 寬度
    const replayer = {
      strokes: [], canvas: null, ctx: null, animationId: null, currentIndex: 0, currentPoint: 0, scale: 1,
      
      open: (idx) => {
        const item = teacher.data[idx];
        const canvas = document.getElementById('replay-canvas');
        document.getElementById('replay-name').innerText = item.name;
        
        ui.openModal('modal-replay');

        try { replayer.strokes = JSON.parse(item.strokes); } catch(e) { replayer.strokes = []; }
        
        // 顯示筆畫數，確認資料是否有載入
        document.getElementById('replay-info').innerText = `(筆畫: ${replayer.strokes ? replayer.strokes.length : 0})`;

        if (!replayer.strokes || replayer.strokes.length === 0) {
            ui.showToast('注意：此作業沒有筆畫紀錄', 'warning');
            return;
        }

        setTimeout(() => {
            // 強制設定內部解析度，不依賴螢幕大小
            canvas.width = 1000;
            canvas.height = 800;
            
            replayer.ctx = canvas.getContext('2d');
            replayer.clear();
            
            if (replayer.strokes.length > 0) {
                 replayer.fitToScreen();
                 replayer.drawFullStatic(); // 先畫出靜態圖
                 replayer.currentIndex = 0; replayer.currentPoint = 0; // 重置播放進度
            }
        }, 100);
      },

      clear: () => {
        if(replayer.animationId) cancelAnimationFrame(replayer.animationId);
        if(replayer.ctx) {
           replayer.ctx.setTransform(1, 0, 0, 1, 0, 0); // 先重置變形
           replayer.ctx.clearRect(0, 0, replayer.canvas.width, replayer.canvas.height);
        }
        replayer.currentIndex = 0; replayer.currentPoint = 0;
      },

      fitToScreen: () => {
          if (!replayer.strokes || replayer.strokes.length === 0) return;
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          
          replayer.strokes.forEach(s => {
             if(s.points) s.points.forEach(p => {
               if(p.x < minX) minX = p.x; if(p.y < minY) minY = p.y;
               if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y;
             });
          });

          if(minX === Infinity) return; // 沒東西可畫

          const padding = 50; // 留邊
          let dw = maxX - minX; 
          let dh = maxY - minY;
          if (dw < 1) dw = 1; if (dh < 1) dh = 1;

          const cw = replayer.canvas.width; 
          const ch = replayer.canvas.height;
          
          // 計算縮放比例
          const scale = Math.min((cw - padding*2)/dw, (ch - padding*2)/dh);
          replayer.scale = scale;

          // 置中
          const ox = (cw - dw*scale)/2 - minX*scale;
          const oy = (ch - dh*scale)/2 - minY*scale;
          
          replayer.ctx.setTransform(scale, 0, 0, scale, ox, oy);
      },

      drawFullStatic: () => {
         if(!replayer.ctx) return;
         replayer.strokes.forEach(s => {
            if (!s.points || s.points.length === 0) return;
            replayer.ctx.beginPath();
            replayer.ctx.lineCap = 'round'; replayer.ctx.lineJoin = 'round';
            replayer.ctx.strokeStyle = s.color; replayer.ctx.fillStyle = s.color; 
            // 根據縮放比例調整線條粗細，避免太細
            replayer.ctx.lineWidth = Math.max(s.size, 3 / replayer.scale);
            
            if (s.points.length === 1) {
                replayer.ctx.arc(s.points[0].x, s.points[0].y, (s.size/2), 0, Math.PI*2); replayer.ctx.fill();
            } else {
                replayer.ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let i=1; i<s.points.length; i++) replayer.ctx.lineTo(s.points[i].x, s.points[i].y);
                replayer.ctx.stroke();
            }
         });
      },

      play: () => {
        replayer.clear();
        if(!replayer.ctx || !replayer.strokes || replayer.strokes.length === 0) return;
        
        replayer.fitToScreen(); // 重新套用縮放

        const speed = parseInt(document.getElementById('replay-speed').value) || 1;
        let ptsPerFrame = speed * 2; 

        const loop = () => {
          for(let k=0; k<ptsPerFrame; k++){
            if(replayer.currentIndex >= replayer.strokes.length) {
               cancelAnimationFrame(replayer.animationId); return;
            }
            const s = replayer.strokes[replayer.currentIndex];
            
            if (!s.points || s.points.length === 0) { replayer.currentIndex++; continue; }
            
            replayer.ctx.lineWidth = Math.max(s.size, 3 / replayer.scale);
            replayer.ctx.strokeStyle = s.color;
            replayer.ctx.fillStyle = s.color;
            replayer.ctx.lineCap = 'round'; replayer.ctx.lineJoin = 'round';

            if (s.points.length === 1 && replayer.currentPoint === 0) {
                 const p = s.points[0];
                 replayer.ctx.beginPath(); 
                 replayer.ctx.arc(p.x, p.y, (s.size/2), 0, Math.PI*2); replayer.ctx.fill();
                 replayer.currentIndex++; continue;
            }

            if(replayer.currentPoint < s.points.length - 1){
              const p1 = s.points[replayer.currentPoint];
              const p2 = s.points[replayer.currentPoint+1];
              replayer.ctx.beginPath(); 
              replayer.ctx.moveTo(p1.x, p1.y); replayer.ctx.lineTo(p2.x, p2.y);
              replayer.ctx.stroke();
              replayer.currentPoint++;
            } else {
              replayer.currentIndex++; replayer.currentPoint = 0;
            }
          }
          replayer.animationId = requestAnimationFrame(loop);
        };
        loop();
      }
    };

    const settings = {
      save: () => { const u = document.getElementById('input-gas-url').value.trim(); if(u){ STATE.gasUrl=u; localStorage.setItem('gas_app_url', u); ui.closeModal('modal-settings'); app.init(); } },
      clear: () => { localStorage.removeItem('gas_app_url'); STATE.gasUrl=''; app.init(); ui.closeModal('modal-settings'); },
      generateShareLink: () => {
        if(!STATE.gasUrl) return ui.alert('錯', '請先儲存網址', 'warning');
        const url = location.origin + location.pathname + '?config=' + btoa(STATE.gasUrl);
        document.getElementById('share-url-input').value = url;
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
        document.getElementById('qr-container').classList.remove('hidden');
      },
      copyShareLink: () => { document.getElementById('share-url-input').select(); document.execCommand('copy'); ui.showToast('已複製', 'success'); }
    };

    const ui = {
      switchPage: (pid) => { document.querySelectorAll('[id^="page-"]').forEach(e => e.classList.add('hidden')); document.getElementById(pid).classList.remove('hidden'); },
      openModal: (mid) => document.getElementById(mid).classList.remove('hidden'),
      closeModal: (mid) => document.getElementById(mid).classList.add('hidden'),
      alert: (t, m, type='info') => {
        document.getElementById('msg-title').innerText = t; document.getElementById('msg-body').innerText = m;
        document.getElementById('msg-icon').innerHTML = type==='success'? '<i class="fa-solid fa-circle-check text-green-500"></i>' : (type==='error'?'<i class="fa-solid fa-circle-xmark text-red-500"></i>':'<i class="fa-solid fa-circle-info text-blue-500"></i>');
        ui.openModal('modal-message');
      },
      showToast: (m, type='info') => {
        const d = document.createElement('div'); d.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg text-white font-bold z-50 ${type==='error'?'bg-red-500':'bg-green-500'}`; d.innerText = m; document.body.appendChild(d); setTimeout(()=>{d.remove()}, 2000);
      },
      showLoading: (show, txt) => {
        if(show){ const d=document.createElement('div'); d.id='loading'; d.className='fixed inset-0 bg-black/30 z-[60] flex flex-col items-center justify-center backdrop-blur-sm'; d.innerHTML=`<i class="fa-solid fa-spinner fa-spin text-white text-4xl mb-4"></i><p class="text-white font-bold">${txt}</p>`; document.body.appendChild(d); }
        else { const d=document.getElementById('loading'); if(d)d.remove(); }
      },
      copyCode: () => { document.getElementById('gas-code-area').select(); document.execCommand('copy'); ui.showToast('已複製', 'success'); }
    };

    window.onload = app.init;
  </script>
</body>
</html>